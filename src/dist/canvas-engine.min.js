(function(f){var l=f.MouseReader,e=f.KeyReader,c=f.AppObject;var g=function(m,n){Object.keys(m).forEach(function(o){if(n[o]===undefined){n[o]=m[o]}});return n};var k={};var b={regex:{PERCENT:/^[0-9]+(\.[0-9]+)?%$/,INT:/^[0-9]+$/,NUMBER:/^-?[0-9]+(\.[0-9]+)?$/,HEXADECIMAL_COLOR:/^#[0-9A-Fa-f]{3}([0-9A-Fa-f]{3})?$/,RGB_COLOR:/^rgb\((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\)$/,RGBA_COLOR:/^rgba\((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(0.[0-9]{1,2}|1)\)$/},isPercent:function(m){return this.regex.PERCENT.test(m)}};var i={};i.dot=function(m,n){return Object.keys(m).reduce(function(o,q){return o+m[q]*n[q]},0)};i.vxv=function(m,o){var n={};Object.keys(m).forEach(function(p){n[p]=m[p]*o[p]});return n};i.vdv=function(m,o){var n={};Object.keys(m).forEach(function(p){n[p]=m[p]/o[p]});return n};i.vpv=function(m,o){var n={};Object.keys(m).forEach(function(p){n[p]=m[p]+o[p]});return n};i.vmv=function(m,o){var n={};Object.keys(m).forEach(function(p){n[p]=m[p]-o[p]});return n};i.sxv=function(o,m){var n={};Object.keys(m).forEach(function(p){n[p]=m[p]*o});return n};i.sdv=function(o,m){var n={};Object.keys(m).forEach(function(p){n[p]=m[p]/o});return n};i.mxv=function(o,n){return o.animation(function(m){return i.dot(m,n)})};i.cross2=function(m,n){return m.x*n.y-m.y*n.x};i.norm=function(m){return i.sqrt(i.dot(m,m))};i.normalize=function(m){return i.sxv(1/i.norm(m),m)};i.med=function(o,n){var m={};Object.keys(o).forEach(function(p){m[p]=(o[p]+n[p])/2});return m};i.rotate=function(r,q,o){var n=i.degreeToRadians(q);o=o===undefined?{x:0,y:0}:o;var s=Math.cos(n);var p=Math.sin(n);var m=r.x-o.x;var t=r.y-o.y;return[(m*s-t*p)+o.x,(t*s+m*p)+o.y]};i.degreeToRadians=function(m){return m*(Math.PI/180)};i.degreeFromVec=function(n,m){var o=i.radiansFromVec(n,m);return i.radiansToDegree(o)};i.radiansFromVec=function(q,p){var o=i.dot(q,p);var n=i.norm(q);var m=i.norm(p);return Math.acos(o/(n*m))};i.radiansToDegree=function(m){return m*(180/Math.PI)};i.distance=function(n,m){return Math.sqrt(Object.keys(n).reduce(function(o,q){return o+Math.pow(n[q]-m[q],2)},0))};i.clockWiseDegreeFromVec=function(n){var m={x:0,y:-1};var o=i.degreeFromVec(n,m);if(n.x<0){o=360-o}return o};i.proportional=function(p,n,m){var o=1;if(n<m){o=m/n;m=p;n=m/o}else{if(n>m){o=n/m;n=p;m=n/o}else{n=p;m=p}}return[n,m]};var a=function(n){var m=this;m.red=0;m.blue=0;m.green=0;m.alpha=1;c.call(m);m.set(n)};a.prototype=Object.create(c.prototype);a.constructor=a;a.prototype.isTransparent=function(){return this.alpha===0};a.random=function(n){n=n===undefined?false:n;var m=new a({red:Math.floor(Math.random()*255),blue:Math.floor(Math.random()*255),green:Math.floor(Math.random()*255),opacity:Math.random()});if(n){return m.toRGBA()}return m.toHEX()};a.prototype.toRGB=function(){var m=this;if(m.isTransparent()){return"transparent"}return"rgb("+m.red+","+m.blue+","+m.green+")"};a.prototype.toRGBA=function(){var m=this;if(m.isTransparent()){return"transparent"}return"rgba("+m.red+","+m.blue+","+m.green+","+m.alpha+")"};a.prototype.toHEX=function(){var n=this;if(n.isTransparent()){return"transparent"}var p=n.red.toString(16);var o=n.blue.toString(16);var m=n.green.toString(16);p=p.length<2?p+"0":p;o=o.length<2?o+"0":o;m=m.length<2?m+"0":m;return("#"+p+o+m).toUpperCase()};a.prototype.toString=function(){var m=this;if(m.isTransparent()){return"transparent"}return m.toRGBA()};a.prototype.reverse=function(){var m=this;m.red=m.red<128?128+(128-m.red):128-(m.red-128);m.blue=m.blue<128?128+(128-m.blue):128-(m.blue-128);m.green=m.green<128?128+(128-m.green):128-(m.green-128);return m};a.asName=function(){var m=this;if(m.isTransparent()){return"transparent"}for(var n in a.Name){if(a.Name[n]===m.toHEX()){return n}}return m.toHEX()};a.Name={Snow:"#FFFAFA",GhostWhite:"#F8F8FF",WhiteSmoke:"#F5F5F5",Gainsboro:"#DCDCDC",FloralWhite:"#FFFAF0",OldLace:"#FDF5E6",Linen:"#FAF0E6",AntiqueWhite:"#FAEBD7",PapayaWhip:"#FFEFD5",BlanchedAlmond:"#FFEBCD",Bisque:"#FFE4C4",PeachPuff:"#FFDAB9",NavajoWhite:"#FFDEAD",Moccasin:"#FFE4B5",Cornsilk:"#FFF8DC",Ivory:"#FFFFF0",LemonChiffon:"#FFFACD",Seashell:"#FFF5EE",Honeydew:"#F0FFF0",MintCream:"#F5FFFA",Azure:"#F0FFFF",AliceBlue:"#F0F8FF",lavender:"#E6E6FA",LavenderBlush:"#FFF0F5",MistyRose:"#FFE4E1",White:"#FFFFFF",Black:"#000000",DarkSlateGray:"#2F4F4F",DimGrey:"#696969",SlateGrey:"#708090",LightSlateGray:"#778899",Grey:"#BEBEBE",LightGray:"#D3D3D3",MidnightBlue:"#191970",NavyBlue:"#000080",CornflowerBlue:"#6495ED",DarkSlateBlue:"#483D8B",SlateBlue:"#6A5ACD",MediumSlateBlue:"#7B68EE",LightSlateBlue:"#8470FF",MediumBlue:"#0000CD",RoyalBlue:"#4169E1",Blue:"#0000FF",DodgerBlue:"#1E90FF",DeepSkyBlue:"#00BFFF",SkyBlue:"#87CEEB",LightSkyBlue:"#87CEFA",SteelBlue:"#4682B4",LightSteelBlue:"#B0C4DE",LightBlue:"#ADD8E6",PowderBlue:"#B0E0E6",PaleTurquoise:"#AFEEEE",DarkTurquoise:"#00CED1",MediumTurquoise:"#48D1CC",Turquoise:"#40E0D0",Cyan:"#00FFFF",LightCyan:"#E0FFFF",CadetBlue:"#5F9EA0",MediumAquamarine:"#66CDAA",Aquamarine:"#7FFFD4",DarkGreen:"#006400",DarkOliveGreen:"#556B2F",DarkSeaGreen:"#8FBC8F",SeaGreen:"#2E8B57",MediumSeaGreen:"#3CB371",LightSeaGreen:"#20B2AA",PaleGreen:"#98FB98",SpringGreen:"#00FF7F",LawnGreen:"#7CFC00",Green:"#00FF00",Chartreuse:"#7FFF00",MedSpringGreen:"#00FA9A",GreenYellow:"#ADFF2F",LimeGreen:"#32CD32",YellowGreen:"#9ACD32",ForestGreen:"#228B22",OliveDrab:"#6B8E23",DarkKhaki:"#BDB76B",PaleGoldenrod:"#EEE8AA",LtGoldenrodYello:"#FAFAD2",LightYellow:"#FFFFE0",Yellow:"#FFFF00",Gold:"#FFD700",LightGoldenrod:"#EEDD82",goldenrod:"#DAA520",DarkGoldenrod:"#B8860B",RosyBrown:"#BC8F8F",IndianRed:"#CD5C5C",SaddleBrown:"#8B4513",Sienna:"#A0522D",Peru:"#CD853F",Burlywood:"#DEB887",Beige:"#F5F5DC",Wheat:"#F5DEB3",SandyBrown:"#F4A460",Tan:"#D2B48C",Chocolate:"#D2691E",Firebrick:"#B22222",Brown:"#A52A2A",DarkSalmon:"#E9967A",Salmon:"#FA8072",LightSalmon:"#FFA07A",Orange:"#FFA500",DarkOrange:"#FF8C00",Coral:"#FF7F50",LightCoral:"#F08080",Tomato:"#FF6347",OrangeRed:"#FF4500",Red:"#FF0000",HotPink:"#FF69B4",DeepPink:"#FF1493",Pink:"#FFC0CB",LightPink:"#FFB6C1",PaleVioletRed:"#DB7093",Maroon:"#B03060",MediumVioletRed:"#C71585",VioletRed:"#D02090",Magenta:"#FF00FF",Violet:"#EE82EE",Plum:"#DDA0DD",Orchid:"#DA70D6",MediumOrchid:"#BA55D3",DarkOrchid:"#9932CC",DarkViolet:"#9400D3",BlueViolet:"#8A2BE2",Purple:"#A020F0",MediumPurple:"#9370DB",Thistle:"#D8BFD8",Snow1:"#FFFAFA",Snow2:"#EEE9E9",Snow3:"#CDC9C9",Snow4:"#8B8989",Seashell1:"#FFF5EE",Seashell2:"#EEE5DE",Seashell3:"#CDC5BF",Seashell4:"#8B8682",AntiqueWhite1:"#FFEFDB",AntiqueWhite2:"#EEDFCC",AntiqueWhite3:"#CDC0B0",AntiqueWhite4:"#8B8378",Bisque1:"#FFE4C4",Bisque2:"#EED5B7",Bisque3:"#CDB79E",Bisque4:"#8B7D6B",PeachPuff1:"#FFDAB9",PeachPuff2:"#EECBAD",PeachPuff3:"#CDAF95",PeachPuff4:"#8B7765",NavajoWhite1:"#FFDEAD",NavajoWhite2:"#EECFA1",NavajoWhite3:"#CDB38B",NavajoWhite4:"#8B795E",LemonChiffon1:"#FFFACD",LemonChiffon2:"#EEE9BF",LemonChiffon3:"#CDC9A5",LemonChiffon4:"#8B8970",Cornsilk1:"#FFF8DC",Cornsilk2:"#EEE8CD",Cornsilk3:"#CDC8B1",Cornsilk4:"#8B8878",Ivory1:"#FFFFF0",Ivory2:"#EEEEE0",Ivory3:"#CDCDC1",Ivory4:"#8B8B83",Honeydew1:"#F0FFF0",Honeydew2:"#E0EEE0",Honeydew3:"#C1CDC1",Honeydew4:"#838B83",LavenderBlush1:"#FFF0F5",LavenderBlush2:"#EEE0E5",LavenderBlush3:"#CDC1C5",LavenderBlush4:"#8B8386",SlateGray4:"#6C7B8B",LightSteelBlue1:"#CAE1FF",LightSteelBlue2:"#BCD2EE",LightSteelBlue3:"#A2B5CD",LightSteelBlue4:"#6E7B8B",LightBlue1:"#BFEFFF",LightBlue2:"#B2DFEE",LightBlue3:"#9AC0CD",LightBlue4:"#68838B",LightCyan1:"#E0FFFF",LightCyan2:"#D1EEEE",LightCyan3:"#B4CDCD",LightCyan4:"#7A8B8B",PaleTurquoise1:"#BBFFFF",PaleTurquoise2:"#AEEEEE",PaleTurquoise3:"#96CDCD",PaleTurquoise4:"#668B8B",CadetBlue1:"#98F5FF",CadetBlue2:"#8EE5EE",CadetBlue3:"#7AC5CD",CadetBlue4:"#53868B",Turquoise1:"#00F5FF",Turquoise2:"#00E5EE",Turquoise3:"#00C5CD",Turquoise4:"#00868B",Cyan1:"#00FFFF",Cyan2:"#00EEEE",Cyan3:"#00CDCD",Cyan4:"#008B8B",DarkSlateGray1:"#97FFFF",DarkSlateGray2:"#8DEEEE",DarkSlateGray3:"#79CDCD",DarkSlateGray4:"#528B8B",Aquamarine1:"#7FFFD4",Aquamarine2:"#76EEC6",Aquamarine3:"#66CDAA",Aquamarine4:"#458B74",DarkSeaGreen1:"#C1FFC1",DarkSeaGreen2:"#B4EEB4",DarkSeaGreen3:"#9BCD9B",DarkSeaGreen4:"#698B69",SeaGreen1:"#54FF9F",SeaGreen2:"#4EEE94",MistyRose1:"#FFE4E1",MistyRose2:"#EED5D2",MistyRose3:"#CDB7B5",MistyRose4:"#8B7D7B",Azure1:"#F0FFFF",Azure2:"#E0EEEE",Azure3:"#C1CDCD",Azure4:"#838B8B",SlateBlue1:"#836FFF",SlateBlue2:"#7A67EE",SlateBlue3:"#6959CD",SlateBlue4:"#473C8B",RoyalBlue1:"#4876FF",RoyalBlue2:"#436EEE",RoyalBlue3:"#3A5FCD",RoyalBlue4:"#27408B",Blue1:"#0000FF",Blue2:"#0000EE",Blue3:"#0000CD",Blue4:"#00008B",DodgerBlue1:"#1E90FF",DodgerBlue2:"#1C86EE",DodgerBlue3:"#1874CD",DodgerBlue4:"#104E8B",SteelBlue1:"#63B8FF",SteelBlue2:"#5CACEE",SteelBlue3:"#4F94CD",SteelBlue4:"#36648B",DeepSkyBlue1:"#00BFFF",DeepSkyBlue2:"#00B2EE",DeepSkyBlue3:"#009ACD",DeepSkyBlue4:"#00688B",SkyBlue1:"#87CEFF",SkyBlue2:"#7EC0EE",SkyBlue3:"#6CA6CD",SkyBlue4:"#4A708B",LightSkyBlue1:"#B0E2FF",LightSkyBlue2:"#A4D3EE",LightSkyBlue3:"#8DB6CD",LightSkyBlue4:"#607B8B",SlateGray1:"#C6E2FF",SlateGray2:"#B9D3EE",SlateGray3:"#9FB6CD",Firebrick4:"#8B1A1A",Brown1:"#FF4040",Brown2:"#EE3B3B",Brown3:"#CD3333",Brown4:"#8B2323",Salmon1:"#FF8C69",Salmon2:"#EE8262",Salmon3:"#CD7054",Salmon4:"#8B4C39",LightSalmon1:"#FFA07A",LightSalmon2:"#EE9572",LightSalmon3:"#CD8162",LightSalmon4:"#8B5742",Orange1:"#FFA500",Orange2:"#EE9A00",Orange3:"#CD8500",Orange4:"#8B5A00",DarkOrange1:"#FF7F00",DarkOrange2:"#EE7600",DarkOrange3:"#CD6600",DarkOrange4:"#8B4500",Coral1:"#FF7256",Coral2:"#EE6A50",Coral3:"#CD5B45",Coral4:"#8B3E2F",Tomato1:"#FF6347",Tomato2:"#EE5C42",Tomato3:"#CD4F39",Tomato4:"#8B3626",OrangeRed1:"#FF4500",OrangeRed2:"#EE4000",OrangeRed3:"#CD3700",OrangeRed4:"#8B2500",Red1:"#FF0000",Red2:"#EE0000",Red3:"#CD0000",Red4:"#8B0000",DeepPink1:"#FF1493",DeepPink2:"#EE1289",DeepPink3:"#CD1076",DeepPink4:"#8B0A50",HotPink1:"#FF6EB4",HotPink2:"#EE6AA7",Gold2:"#EEC900",HotPink3:"#CD6090",HotPink4:"#8B3A62",Pink1:"#FFB5C5",Pink2:"#EEA9B8",Pink3:"#CD919E",Pink4:"#8B636C",LightPink1:"#FFAEB9",LightPink2:"#EEA2AD",LightPink3:"#CD8C95",LightPink4:"#8B5F65",PaleVioletRed1:"#FF82AB",PaleVioletRed2:"#EE799F",PaleVioletRed3:"#CD6889",PaleVioletRed4:"#8B475D",Maroon1:"#FF34B3",Maroon2:"#EE30A7",Maroon3:"#CD2990",Maroon4:"#8B1C62",VioletRed1:"#FF3E96",VioletRed2:"#EE3A8C",VioletRed3:"#CD3278",VioletRed4:"#8B2252",Magenta1:"#FF00FF",Magenta2:"#EE00EE",Magenta3:"#CD00CD",Magenta4:"#8B008B",Orchid1:"#FF83FA",Orchid2:"#EE7AE9",Orchid3:"#CD69C9",Orchid4:"#8B4789",Plum1:"#FFBBFF",Plum2:"#EEAEEE",Plum3:"#CD96CD",Plum4:"#8B668B",MediumOrchid1:"#E066FF",MediumOrchid2:"#D15FEE",MediumOrchid3:"#B452CD",MediumOrchid4:"#7A378B",DarkOrchid1:"#BF3EFF",DarkOrchid2:"#B23AEE",DarkOrchid3:"#9A32CD",DarkOrchid4:"#68228B",Purple1:"#9B30FF",Purple2:"#912CEE",SeaGreen3:"#43CD80",SeaGreen4:"#2E8B57",PaleGreen1:"#9AFF9A",PaleGreen2:"#90EE90",PaleGreen3:"#7CCD7C",PaleGreen4:"#548B54",SpringGreen1:"#00FF7F",SpringGreen2:"#00EE76",SpringGreen3:"#00CD66",SpringGreen4:"#008B45",Green1:"#00FF00",Green2:"#00EE00",Green3:"#00CD00",Green4:"#008B00",Chartreuse1:"#7FFF00",Chartreuse2:"#76EE00",Chartreuse3:"#66CD00",Chartreuse4:"#458B00",OliveDrab1:"#C0FF3E",OliveDrab2:"#B3EE3A",OliveDrab3:"#9ACD32",OliveDrab4:"#698B22",DarkOliveGreen1:"#CAFF70",DarkOliveGreen2:"#BCEE68",DarkOliveGreen3:"#A2CD5A",DarkOliveGreen4:"#6E8B3D",Khaki1:"#FFF68F",Khaki2:"#EEE685",Khaki3:"#CDC673",Khaki4:"#8B864E",LightGoldenrod1:"#FFEC8B",LightGoldenrod2:"#EEDC82",LightGoldenrod3:"#CDBE70",LightGoldenrod4:"#8B814C",LightYellow1:"#FFFFE0",LightYellow2:"#EEEED1",LightYellow3:"#CDCDB4",LightYellow4:"#8B8B7A",Yellow1:"#FFFF00",Yellow2:"#EEEE00",Yellow3:"#CDCD00",Yellow4:"#8B8B00",Gold1:"#FFD700",Gold3:"#CDAD00",Gold4:"#8B7500",Goldenrod1:"#FFC125",Goldenrod2:"#EEB422",Goldenrod3:"#CD9B1D",Goldenrod4:"#8B6914",DarkGoldenrod1:"#FFB90F",DarkGoldenrod2:"#EEAD0E",DarkGoldenrod3:"#CD950C",DarkGoldenrod4:"#8B658B",RosyBrown1:"#FFC1C1",RosyBrown2:"#EEB4B4",RosyBrown3:"#CD9B9B",RosyBrown4:"#8B6969",IndianRed1:"#FF6A6A",IndianRed2:"#EE6363",IndianRed3:"#CD5555",IndianRed4:"#8B3A3A",Sienna1:"#FF8247",Sienna2:"#EE7942",Sienna3:"#CD6839",Sienna4:"#8B4726",Burlywood1:"#FFD39B",Burlywood2:"#EEC591",Burlywood3:"#CDAA7D",Burlywood4:"#8B7355",Wheat1:"#FFE7BA",Wheat2:"#EED8AE",Wheat3:"#CDBA96",Wheat4:"#8B7E66",Tan1:"#FFA54F",Purple3:"#7D26CD",Purple4:"#551A8B",MediumPurple1:"#AB82FF",MediumPurple2:"#9F79EE",MediumPurple3:"#8968CD",MediumPurple4:"#5D478B",Thistle1:"#FFE1FF",Thistle2:"#EED2EE",Thistle3:"#CDB5CD",Thistle4:"#8B7B8B",grey11:"#1C1C1C",grey21:"#363636",grey31:"#4F4F4F",grey41:"#696969",grey51:"#828282",grey61:"#9C9C9C",grey71:"#B5B5B5",gray81:"#CFCFCF",gray91:"#E8E8E8",DarkGrey:"#A9A9A9",DarkBlue:"#00008B",DarkCyan:"#008B8B",DarkMagenta:"#8B008B",DarkRed:"#8B0000",LightGreen:"#90EE90",Chocolate3:"#CD661D",Chocolate4:"#8B4513",Firebrick1:"#FF3030",Firebrick2:"#EE2C2C",Firebrick3:"#CD2626",Tan2:"#EE9A49",Tan3:"#CD853F",Tan4:"#8B5A2B",Chocolate1:"#FF7F24",Chocolate2:"#EE7621"};a.Patterns={HEXADECIMAL:/^#[0-9A-Fa-f]{3}([0-9A-Fa-f]{3})?$/,RGB:/^rgb\((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\)$/,RGBA:/^rgba\((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2}),(0.[0-9]{1,2}|1)\)$/,NAME:/^[A-Z][a-zA-z0-9]{2,15}$/};a.isColor=function(m){m=a.parse(m);return m!==null};a.parse=function(s){var o=null;if(typeof s==="string"){var q;var p;var m;if(s==="transparent"){o=new a({alpha:0})}else{if(a.Patterns.HEXADECIMAL.test(s)){s=s.substr(s.indexOf("#")+1,s.length);q=parseInt(s.substr(0,2),16);p=parseInt(s.substr(2,2),16);m=parseInt(s.substr(4,2),16);o=new a({red:q,blue:p,green:p})}else{if(a.Patterns.RGB.test(s)){s=s.replace("rgb(","").replace(")","").split(",");q=parseInt(s[0]);p=parseInt(s[1]);m=parseInt(s[2]);o=new a({red:q,blue:m,green:p})}else{if(a.Patterns.RGBA.test(s)){s=s.replace("rgba(","").replace(")","").split(",");q=parseInt(s[0]);p=parseInt(s[1]);m=parseInt(s[2]);var n=parseFloat(s[3]);o=new a({red:q,blue:m,green:p,alpha:n})}else{if(a.Patterns.NAME.test(s)){o=a.parse(a.Name[s])}}}}}}return o};var d={rect:{x:0,y:0,width:10,height:10,fillStyle:"transparent",strokeStyle:"black",opacity:100,origin:{x:0,y:0}},circle:{x:0,y:0,radius:10,fillStyle:"transparent",strokeStyle:"black",opacity:100,origin:{x:0,y:0}},polygon:{fillStyle:"transparent",strokeStyle:"black",origin:{x:0,y:0},opacity:100,points:[]},image:{image:null,sx:0,sy:0,sWidth:"auto",sHeight:"auto",dx:0,dy:0,dWidth:"auto",dHeight:"auto"},text:{text:"",fillStyle:"black"}};var j=function(o,n){console.log("Canvas Layer initialize...");var m=this;m.type="layer";m.context=null;m.element=null;m.canvas=n;m.zIndex=0;m.width=300;m.height=300;m.left=0;m.top=0;m.savedStates=[];m.name="";m.mouseReader=null;m.opacity=1;m.visible=true;m.backgroundColor="transparent";m.transparentRegex=/^\s*transparent\s*|rgba\((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\s*,\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\s*,\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\s*,\s*0\s*\)\s*$/;c.call(m);j.bindProperties.apply(m);m.set(o)};j.prototype=Object.create(c.prototype);j.prototype.constructor=j;j.bindProperties=function(){var m=this;m._onChange("zIndex",function(n){$(m.getElement()).css({zIndex:n}).data("zindex",n)});m._onChange("opacity",function(n){$(m.getElement()).css({opacity:n}).data("opacity",n)});m._onChange("visible",function(n){if(n){m.show()}else{m.hide()}$(m.getElement()).data("visible",n)});m._onChange("width",function(n){$(m.getElement()).prop("width",n);if(m.canvas.aligner_width<n){m.canvas.set({aligner_width:n})}});m._onChange("height",function(n){$(m.getElement()).prop("height",n);if(m.canvas.aligner_height<n){m.canvas.set({aligner_height:n})}});m._onChange("name",function(n){if(n.length===0){$(m.getElement()).removeAttr("data-name").data("name","")}else{$(m.getElement()).data("name",n)}});m._onChange("left",function(n){$(m.getElement()).css({left:n}).data("left",n)});m._onChange("top",function(n){$(m.getElement()).css({top:n}).data("top",n)});m._onChange("backgroundColor",function(n){$(m.getElement()).css({backgroundColor:n}).data("backgroundColor",n)});m._onChange("element",function(n){m.context=null})};j.prototype.getVisibleArea=function(){var o=this;var p=Math.min(o.width,o.canvas.getWidth());var n=Math.min(o.height,o.canvas.getHeight());var m=Math.abs(o.canvas.viewX);var q=Math.abs(o.canvas.viewY);return{x:m,y:q,width:p,height:n}};j.prototype.isSetVisible=function(n){var m=this;var o=m.getVisibleArea();return !(n.x+n.width<o.x||o.x+o.width<n.x||n.y+n.height<o.y||o.y+o.height<n.y)};j.prototype.show=function(){var m=this;$(m.getElement()).css({visibility:"visible"});return m};j.prototype.hide=function(){var m=this;$(m.getElement()).css({visibility:"hidden"});return m};j.prototype.saveState=function(p){var n=this;var o=n.getElement().toDataURL("image/png");var m=document.createElement("img");m.src=o;n.savedStates[p]=m;return n};j.prototype.restoreState=function(n){var m=this;var o=m.savedStates[n];if(o!==undefined){m.getContext().drawImage(o,0,0)}return m};j.prototype.clearStates=function(){var m=this;m.savedStates=[];return m};j.prototype.getElement=function(){var m=this;if(m.element===null){m.element=document.createElement("canvas");$(m.element).css({pointerEvents:"none",userSelect:"none",position:"absolute",left:m.left,top:m.top,backgroundColor:m.backgroundColor,opacity:m.opacity});$(m.element).addClass("canvas-layer")}return m.element};j.prototype.getContext=function(){var m=this;if(m.context===null){m.context=m.getElement().getContext("2d");if(m.context.setLineDash===undefined){m.context.setLineDash=function(){}}}return m.context};j.prototype.getRatio=function(){var m=this;var n=m.getContext();var o=n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1;return o};j.prototype.destroy=function(){var m=this;$(m.element).remove();if(m.canvas.layers[m.zIndex]!==undefined){delete m.canvas.layers[m.zIndex]}};j.prototype.drawImage=function(){var m=this;var n=m.getContext();n.drawImage.apply(n,arguments);return m};j.prototype.clear=function(){var m=this;m.getContext().clearRect(0,0,m.width,m.height);return m};j.prototype.drawAnimation=function(n){var m=this;m.clearRect({x:n.x,y:n.y,width:n.width,height:n.height});if(n.frames[n.indexFrame]!==undefined){var o=n.frames[n.indexFrame];m.image(o)}return m};j.prototype.getPixel=function(q,n){var m=this;var o=m.getContext();var r=o.getImageData(q,n,1,1).data;return new a({red:r[0],green:r[1],blue:r[2],alpha:r[3]})};j.prototype.text=function(n){var m=this;n=n===undefined?d.text:g(d.text,n);m.setContext(n);m.getContext().fill()};j.prototype.image=function(A){var y=this;A=A===undefined?d.image:g(d.image,A);var p=A.image;if(p!==null&&p instanceof HTMLImageElement){var u=A.dWidth;var q=A.dHeight;var n=A.sWidth;var r=A.sHeight;var w=A.sx;var v=A.sy;var z=A.dx;var x=A.dy;var s=parseFloat(A.opacity);var t;if(u==="auto"&&q==="auto"){u=p.width;q=p.height}else{if(u==="auto"&&!isNaN(parseFloat(q))){u=p.width*(q/p.height)}else{if(q==="auto"&&!isNaN(parseFloat(u))){q=p.height*(u/p.width)}}}if(!isNaN(parseFloat(A.sWidth))&&A.sWidth>0){n=A.sWidth}else{if(b.isPercent(A.sWidth)){t=parseFloat(A.sWidth.replace("%",""));n=p.width*(t/100)}else{n=p.width}}if(!isNaN(parseFloat(A.sHeight))&&A.sHeight>0){r=A.sHeight}else{if(b.isPercent(A.sHeight)){t=parseFloat(A.sHeight.replace("%",""));r=p.height*(t/100)}else{r=p.height}}if(b.isPercent(A.dWidth)){t=parseFloat(A.dWidth.replace("%",""));u=n*(t/100)}else{if(!isNaN(parseFloat(A.dWidth))&&A.dWidth>0){u=A.dWidth}}if(b.isPercent(A.dHeight)){t=parseFloat(A.dHeight.replace("%",""));q=r*(t/100)}else{if(!isNaN(parseFloat(A.dHeight))&&A.dHeight>0){q=A.dHeight}}if(b.isPercent(w)){t=parseFloat(w.replace("%",""));w=p.width*(t/100)}if(b.isPercent(v)){t=parseFloat(v.replace("%",""));v=p.height*(t/100)}var m=y.getContext();m.save();if(!isNaN(s)){y.getContext().globalAlpha=s/100}var o=y.canvas.scale;if(u>0&&q>0){m.drawImage(p,w,v,n,r,z*o,x*o,u*o,q*o)}m.restore()}};j.prototype.circle=function(n){var m=this;n=n===undefined?d.circle:g(d.circle,n);var o=m.getContext();o.save();m.setContext(n);o.beginPath();o.arc(n.x,n.y,n.radius,0,2*Math.PI);if(o.fillStyle!==null&&!m.transparentRegex.test(o.fillStyle)){o.fill()}if(o.strokeStyle!==null&&!m.transparentRegex.test(o.strokeStyle)){o.stroke()}o.restore();return m};j.prototype.rect=function(n){var m=this;n=n===undefined?j.default_options.rect:g(j.default_options.rect,n);var o=m.getContext();o.save();m.setContext(n);if(o.fillStyle!==null&&!m.transparentRegex.test(o.fillStyle)){o.fillRect(n.x,n.y,n.width,n.height)}if(o.strokeStyle!==null&&!m.transparentRegex.test(o.strokeStyle)){o.strokeRect(n.x,n.y,n.width,n.height)}o.restore();return m};j.prototype.clearRect=function(n){var m=this;n=n===undefined?d.rect:g(d.rect,n);var o=m.getContext();var p=m.canvas.scale;o.clearRect(n.x*p,n.y*p,n.width*p,n.height*p);return m};j.prototype.clearCircle=function(n){var m=this;n=n===undefined?j.default_options.circle:g(j.default_options.circle,n);var o=m.getContext();o.save();o.arc(n.x,n.y,n.radius,0,Math.PI);o.clip();o.clearRect(n.x-n.radius,n.y-n.radius,n.radius*2,n.radius*2);o.restore();return m};j.prototype.polygon=function(n){var m=this;n=n===undefined?d.polygon:g(d.polygon,n);var r=n.points.length;var q=m.getContext();q.save();m.setContext(n);if(r>0){q.beginPath();var s=n.points[0];q.moveTo(s[0],s[1]);for(var o=1;o<r;o++){s=n.points[o];q.lineTo(s[0],s[1])}q.closePath();if(q.fillStyle!==null&&!m.transparentRegex.test(q.fillStyle)){q.fill()}if(q.strokeStyle!==null&&!m.transparentRegex.test(q.strokeStyle)){q.stroke()}}q.restore();return m};j.prototype.setContext=function(p){var o=this;var q=o.getContext();if(p.fillStyle!==undefined){q.fillStyle=p.fillStyle}if(p.strokeStyle!==undefined){q.strokeStyle=p.strokeStyle}if(p.lineDash!==undefined&&p.lineDash instanceof Array){q.setLineDash(p.lineDash)}if(p.opacity!==undefined){q.globalAlpha=p.opacity/100}if(p.origin!==undefined){var n=0;var m=0;if(typeof p.origin==="string"){switch(p.origin){case"center":n=p.x+(p.width/2);m=p.y+(p.height/2);break}}else{if(typeof p==="object"){n=p.origin.x;m=p.origin.y}}q.translate(n,m);p.x=p.x-n;p.y=p.y-m}if(p.rotate!==undefined){var r=p.rotate*(Math.PI/180);q.rotate(r)}return o};var h=function(n){console.log("initializing canvas engine...");var m=this;m.layers=[];m.height=400;m.width=400;m.viewX=0;m.viewY=0;m.lastViewX=0;m.lastViewY=0;m.width=400;m.mouseReader=null;m.keyReader=null;m.draggable=false;m.scalable=false;m.scale=1;m.container=null;m.aligner_width=400;m.aligner_height=400;m.aligner=null;m.moving_x=false;m.moving_y=false;c.call(m);h.bindProperties.apply(m);m.set(n);h.initialize.apply(m)};h.prototype=Object.create(c.prototype);h.prototype.constructor=h;h.initialize=function(){var m=this;var n=m.getMouseReader();n.onmousedown(3,function(){m.lastViewX=m.viewX;m.lastViewY=m.viewY});n.onmousemove(function(s){var r=this;if(m.draggable&&r.right){var A=r.lastDown.right;var w=r.lastMove;var o=i.vmv(A,w);var z=m.lastViewX-o.x;var u=m.lastViewY-o.y;var q=m.getLayer(0);var v=m.getWidth()-q.width;var t=m.getHeight()-q.height;v=v>0?0:v;t=t>0?0:t;z=Math.min(Math.max(z,v),0);u=Math.min(Math.max(u,t),0);m.set({viewX:z,viewY:u})}})};h.bindProperties=function(){var m=this;m._beforeSet("viewX",function(n,o){if(o>0){return 0}return o});m._beforeSet("viewY",function(n,o){if(o>0){return 0}return o});m._onChange("viewX",function(n){$(m.aligner).css({left:n})});m._onChange("viewY",function(n){$(m.aligner).css({top:n})});m._onChange("aligner_width",function(n){$(m.getAligner()).css({width:n})});m._onChange("aligner_height",function(n){$(m.getAligner()).css({height:n})});m._onChange("width",function(n){$(m.container).css({width:n})});m._onChange("height",function(n){$(m.container).css({height:n})});m._onChange("container",function(n){$(n).css({position:"relative",overflow:"hidden",width:m.width,height:m.height,padding:0}).addClass("transparent-background canvas-engine").on("contextmenu",function(o){o.preventDefault()}).css({outline:"none"});$(n).append(m.getAligner());m.getMouseReader().set({element:n});m.keyReader=null})};h.prototype.getAligner=function(){var m=this;if(m.aligner===null){var n=document.createElement("div");$(n).css({pointerEvents:"none",userSelect:"none",position:"relative",width:m.width,height:m.height,left:0,top:0}).addClass("aligner");m.aligner=n}return m.aligner};h.prototype.getMouseReader=function(){var m=this;if(m.mouseReader===null){m.mouseReader=new l({element:m.container})}return m.mouseReader};h.prototype.getKeyReader=function(){var m=this;if(m.keyReader===null){m.keyReader=new e(m.container)}return m.keyReader};h.prototype.getWidth=function(){return $(this.container).width()};h.prototype.getHeight=function(){return $(this.container).height()};h.prototype.clearAllLayers=function(){var m=this;this.layers.forEach(function(n){n.clear()});return m};h.prototype.applyToLayers=function(n,o){var m=this;m.layers.forEach(function(p){if(o===undefined||o.apply(p)){p.set(n)}});return m};h.prototype.createLayer=function(o,r){o=o===undefined?{}:o;var p=null;var n=this;o.zIndex=n.layers.length;var q=parseFloat(o.width);var m=parseFloat(o.height);var s=o.fixed===undefined?false:o.fixed;o.width=isNaN(q)?n.getWidth():q;o.height=isNaN(m)?n.getHeight():m;if(r!==undefined){p=new r(o,n)}else{p=new j(o,n)}n.layers.push(p);if(s){$(n.container).append(p.getElement())}else{$(n.getAligner()).append(p.getElement())}return p};h.prototype.getLayer=function(n){var m=this;if(m.layers[n]!==undefined){return m.layers[n]}return null};h.prototype.removeLayers=function(n){var m=this;n.forEach(function(o){m.removeLayer(o)})};h.prototype.removeLayer=function(p){var m=this;var n=-1;if(p instanceof j){n=m.layers.indexOf(p)}else{if(b.isInt(p)&&m.layers[p]!==undefined){n=p}}if(n!==-1){m.layers[n].destroy();m.layers.splice(n,1);for(var o=n;o<m.layers.length;o++){m.layers[o].set({zIndex:o})}}return m};h.prototype.getPosition=function(m){var n=this;var o={x:-n.viewX/n.scale,y:-n.viewY/n.scale};return i.vpv(i.sdv(n.scale,m),o)};k.createEngine=function(m,n){if(n===undefined){return new h(m)}return new n(m)};k.Color=a;k.AppObject=c;k.Validator=b;k.CE=h;k.CanvasLayer=j;k.Math=i;f.CE=k})(window);