define(["Color"],function(a){return{filterList:[],filtering:false,canvas:null,context:null,getCanvas:function(b,d){var c=this;if(c.canvas==null){c.canvas=document.createElement("canvas");c.canvas.width=b;c.canvas.height=d}else{if(b!=undefined&&c.canvas.width!=b){c.canvas.width=b}if(d!=undefined&&c.canvas.height!=d){c.canvas.height=d}}return c.canvas},getPixels:function(d){var e=this.getCanvas(d.width,d.height);var b=e.getContext("2d");b.drawImage(d,0,0);return b.getImageData(0,0,d.width,d.height)},createImageData:function(b,c){return this.getCanvas(b,c).getContext("2d").createImageData(b,c)},applyFilter:function(d,f,i,j){var k=this;if(!k.filtering){k.filtering=true;var i=[this.getPixels(f)].concat(i);var b=d.apply(k,i);var e=k.getCanvas(b.width,b.height);var l=e.getContext("2d");l.putImageData(b,0,0);var c=e.toDataURL("image/png");var g=document.createElement("img");g.onload=function(){j(g)};g.src=c;k.filtering=false;if(k.filterList.length>0){var h=k.filterList.shift();k.applyFilter.apply(k,h)}}else{k.filterList.push([d,f,i,j])}},removeColor:function(g,c){var b=this;var f=g.data;var e=f.length;for(var d=0;d<e;d+=4){if(f[d+3]!=0&&f[d]==c.red&&f[d+1]==c.blue&&f[d+2]==c.green){f[d]=255;f[d+1]=255;f[d+2]=255;f[d+3]=0}}return g},trim:function(b){var n=this;var g=b.data;var o=g.length;var j=null;var e=null;var l=null;var c=null;var k=0;var h=0;for(var f=0;f<o;f+=4){if(g[f+3]!==0){k=(f/4)%b.width;h=~~((f/4)/b.width);if(j===null){j=h}if(e===null){e=k}else{if(k<e){e=k}}if(l===null){l=k}else{if(l<k){l=k}}if(c===null){c=h}else{if(c<h){c=h}}}}var m=c-j;var d=l-e;return{x:e,y:j,width:d,height:m}},convolute:function(v,F,k){var d=Math.round(Math.sqrt(F.length));var i=Math.floor(d/2);var j=v.data;var z=v.width;var I=v.height;var p=z;var D=I;var l=this.createImageData(p,D);var J=l.data;var q=k?1:0;for(var m=0;m<D;m++){for(var n=0;n<p;n++){var t=m;var u=n;var A=(m*p+n)*4;var s=0,E=0,G=0,H=0;for(var e=0;e<d;e++){for(var f=0;f<d;f++){var B=t+e-i;var C=u+f-i;if(B>=0&&B<I&&C>=0&&C<z){var o=(B*z+C)*4;var c=F[e*d+f];s+=j[o]*c;E+=j[o+1]*c;G+=j[o+2]*c;H+=j[o+3]*c}}}J[A]=s;J[A+1]=E;J[A+2]=G;J[A+3]=H+q*(255-H)}}return l},invert:function(d){var c=d.data;for(var b=0;b<c.length;b+=4){c[b]=255-c[b];c[b+1]=255-c[b+1];c[b+2]=255-c[b+2]}return d}}});