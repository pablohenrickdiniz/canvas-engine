define(["AppObject","Math","MouseReader","CanvasLayer","KeyReader","Grid","jquery","Validator"],function(c,a,i,g,f,d,e,b){var h=function(k){console.log("intializing canvas engine...");var j=this;j.layers=[];j.height=400;j.width=400;j.viewX=0;j.viewY=0;j.lastViewX=0;j.lastViewY=0;j.width=400;j.mouseReader=null;j.keyReader=null;j.draggable=false;j.scalable=false;j.selectable=false;j.multiSelect=false;j.grid=null;j.scale=1;j.gridLayer=null;j.animationLayer=null;j.areaSelect=null;j.container=null;h.bindProperties.apply(j);j.set(k);j.initialize()};h.prototype=new c();h.bindProperties=function(){var j=this;j._onChange("viewX",function(k){j.layers.forEach(function(l){e(l.getElement()).css({left:k})})});j._onChange("viewY",function(k){j.layers.forEach(function(l){e(l.getElement()).css({top:k})})});j._beforeSet("scale",function(){return 1});j._onChange("width",function(k){e(j.container).css({width:k})});j._onChange("height",function(k){e(j.container).css({height:k})});j._onChange("container",function(k){console.log("container changed!");e(k).css({position:"relative",overflow:"hidden",width:j.width,height:j.height}).addClass("transparent-background canvas-engine").on("contextmenu",function(l){l.preventDefault()})})};h.prototype.initialize=function(){var j=this;e(j.container).empty();j.getMouseReader().onmousedown(3,function(){j.lastViewX=j.viewX;j.lastViewY=j.viewY});j.getMouseReader().onmousemove(function(n){var m=this;if(j.draggable&&m.right){var u=m.lastDown.right;var s=m.lastMove;var k=a.vmv(u,s);var t=j.lastViewX-k.x;var q=j.lastViewY-k.y;var l=j.getLayer(0);var r=j.getWidth()-l.width;var o=j.getHeight()-l.height;r=r>0?0:r;o=o>0?0:o;t=a.min(a.max(t,r),0);q=a.min(a.max(q,o),0);j.set({viewX:t,viewY:q})}});j.getMouseReader().onmousewheel(function(l){var k=this;if(j.scalable){var m=k.lastWheel;if(m<0){if(j.scale>0.2){j.set({scale:j.scale-0.1})}}else{if(m>0){j.set({scale:j.scale+0.1})}}}});j.getMouseReader().onmousedown(1,function(){if(j.selectable&&typeof j.areaSelect==="function"){var k=this;var o={x:a.abs(j.viewX/j.scale),y:a.abs(j.viewY/j.scale)};var m=a.vpv(a.sdv(j.scale,k.lastDown.left),o);var n={x:m.x,y:m.y};var l=j.getGrid();j.areaSelect.apply(j,[n,l]);j.refreshGridLayer()}});j.getMouseReader().onmousemove(function(n){if(j.multiSelect&&j.selectable&&typeof j.areaSelect==="function"){console.log("mouse move...");var k=this;var l=j.getGrid();var m=null;if(k.left){m=j.getDrawedArea()}else{m=a.vpv(a.sdv(j.scale,k.lastMove),{x:-j.viewX/j.scale,y:-j.viewY/j.scale})}j.areaSelect.apply(j,[m,l]);j.refreshGridLayer()}})};h.prototype.getDrawedArea=function(){var l=this;var k=l.getMouseReader();var q={x:-l.viewX/l.scale,y:-l.viewY/l.scale};var o=a.vpv(a.sdv(l.scale,k.lastDown.left),q);var m=a.vpv(a.sdv(l.scale,k.lastMove),q);var n=a.abs(m.x-o.x);var j=a.abs(m.y-o.y);var p={x:o.x,y:o.y,width:n,height:j};p.x=o.x>m.x?p.x-n:p.x;p.y=o.y>m.y?p.y-j:p.y;return p};h.prototype.refreshGridLayer=function(){var j=this;j.getGridLayer().clear().drawGrid(j.getGrid())};h.prototype.onAreaSelect=function(k){var j=this;j.areaSelect=k;return j};h.prototype.updateGrid=function(k){var j=this;j.getGridLayer().set(k).clear().drawGrid(j.getGrid().set(k));return j};h.prototype.redrawGrid=function(){var j=this;j.getGridLayer().clear().drawGrid(j.getGrid());return j};h.prototype.getGridLayer=function(){var j=this;if(j.gridLayer===null){j.gridLayer=j.createLayer()}return j.gridLayer};h.prototype.getGrid=function(){var k=this;if(k.grid===null){var l=k.getWidth();var j=k.getHeight();k.grid=new d({sw:l,sh:j,width:l,height:j})}return k.grid};h.prototype.getMouseReader=function(){console.log("Canvas Engine get mouse reader...");var j=this;if(j.mouseReader===null){j.mouseReader=new i(j.container)}return j.mouseReader};h.prototype.getKeyReader=function(){console.log("Canvas Engine get key reader...");var j=this;if(j.keyReader===null){j.keyReader=new f(j.container)}return j.keyReader};h.prototype.getWidth=function(){console.log("Canvas Engine get width...");return e(this.container).width()};h.prototype.getHeight=function(){console.log("Canvas Engine get height...");return e(this.container).height()};h.prototype.clearAllLayers=function(){console.log("Canvas engine clear all layers...");this.layers.forEach(function(j){j.clear()});return self};h.prototype.applyToLayers=function(k,l){console.log("Canvas engine apply to layers...");var j=this;j.layers.forEach(function(m){if(l===undefined||l.apply(m)){m.set(k)}});return j};h.prototype.createLayer=function(k,o){console.log("Canvas engine create layer..");k=b.validateObject({},k);var n=b.validateString("default",k.type);var l=null;var j=this;k.zIndex=j.layers.length;console.log(k);k.width=b.validateNumber(j.getWidth(),k.width);k.height=b.validateNumber(j.getHeight(),k.height);if(o!==undefined){l=new o(k,j)}else{l=new g(k,j)}j.layers.push(l);if(j.gridLayer!==null){var m=j.layers[j.layers.length-1];j.layers[j.layers.length-1]=j.gridLayer;j.layers[j.gridLayer.zIndex]=m;m.set({zIndex:j.gridLayer.zIndex});j.gridLayer.set({zIndex:j.layers.length-1})}e(document).ready(function(){e(j.container).append(l.getElement())});return l};h.prototype.getLayer=function(k){console.log("Canvas Engine get layer...");var j=this;if(j.layers[k]!==undefined){return j.layers[k]}return null};h.prototype.removeLayers=function(k){var j=this;k.forEach(function(l){j.removeLayer(l.zIndex)})};h.prototype.removeLayer=function(k){console.log("Canvas Engine remove layer...");var j=this;if(j.layers[k]!==undefined){j.layers[k].destroy();j.layers.splice(k,1);for(var l=k;l<j.layers.length;l++){j.layers[l].set({zIndex:l})}}return j};h.prototype.renderMap=function(q){console.log("Canvas Engine render map...");var k=this;k.clearAllLayers();var o=q.imageSets;var p=o.length;q.renderIntervals.forEach(function(j){clearInterval(j)});for(var m=0;m<p;m++){var n=o[m].length;for(var l=0;l<n;l++){o[m][l].forEach(function(j){q.renderIntervals.push(setTimeout(function(){var r=k.getLayer(j.layer);if(r!==null){r.set({width:q.width*q.tile_w,height:q.height*q.tile_h});r.drawImageSet(j)}},(20*m)+(l*20)))})}}q.parent=k};h.createEngine=function(j){console.log("Canvas Engine create engine...");return new h(j)};return h});