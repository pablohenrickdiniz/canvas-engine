define(["AppObject","Math","MouseReader","CanvasLayer","KeyReader","Grid","jquery"],function(a,e,d,c,h,b,f){var g=function(j){console.log("intializing canvas engine...");var i=this;i.layers=[];i.height=400;i.width=400;i.viewX=0;i.viewY=0;i.lastViewX=0;i.lastViewY=0;i.width=400;i.mouseReader=null;i.keyReader=null;i.draggable=false;i.scalable=false;i.selectable=false;i.multiSelect=false;i.grid=null;i.scale=1;i.gridLayer=null;i.animationLayer=null;i.areaSelect=null;i.container=null;g.bindProperties.apply(i);i.set(j);i.initialize()};g.prototype=new a();g.bindProperties=function(){var i=this;i.onChange("viewX",function(j){i.layers.forEach(function(k){f(k.getElement()).css({left:j})})});i.onChange("viewY",function(j){i.layers.forEach(function(k){f(k.getElement()).css({top:j})})});i.onChange("scale",function(j){i.layers.forEach(function(k){f(k.getElement()).css({transform:"scale("+j+","+j+")",transformOrigin:"0 0",webkitTransform:"scale("+j+","+j+")",webkitTransformOrigin:"0 0",mozTransform:"scale("+j+")",mozTransformOrigin:"0 0",oTransform:"scale("+j+","+j+")",oTransformOrigin:"0 0",msTransform:"scale("+j+","+j+")",msTransformOrigin:"0 0"})})});i.onChange("width",function(j){f(i.container).css({width:j})});i.onChange("height",function(j){f(i.container).css({height:j})});i.onChange("container",function(j){console.log("container changed!");f(j).css({position:"relative",overflow:"hidden",width:i.width,height:i.height}).addClass("transparent-background canvas-engine").on("contextmenu",function(k){k.preventDefault()})})};g.prototype.initialize=function(){var i=this;f(i.container).empty();i.getMouseReader().onmousedown(3,function(){i.lastViewX=i.viewX;i.lastViewY=i.viewY});i.getMouseReader().onmousemove(function(m){var l=this;if(i.draggable&&l.right){var t=l.lastDown.right;var r=l.lastMove;var j=e.vmv(t,r);var s=i.lastViewX-j.x;var o=i.lastViewY-j.y;var k=i.getLayer(0);var q=i.getWidth()-k.width;var n=i.getHeight()-k.height;q=q>0?0:q;n=n>0?0:n;s=e.min(e.max(s,q),0);o=e.min(e.max(o,n),0);i.set({viewX:s,viewY:o})}});i.getMouseReader().onmousewheel(function(k){var j=this;if(i.scalable){var l=j.lastWheel;if(l<0){if(i.scale>0.2){i.set({scale:i.scale-0.1})}}else{if(l>0){i.set({scale:i.scale+0.1})}}}});i.getMouseReader().onmousedown(1,function(){if(i.selectable&&typeof i.areaSelect==="function"){var j=this;var n={x:e.abs(i.viewX/i.scale),y:e.abs(i.viewY/i.scale)};var l=e.vpv(e.sdv(i.scale,j.lastDown.left),n);var m={x:l.x,y:l.y};var k=i.getGrid();i.areaSelect.apply(i,[m,k]);i.refreshGridLayer()}});i.getMouseReader().onmousemove(function(m){if(i.multiSelect&&i.selectable&&typeof i.areaSelect==="function"){console.log("mouse move...");var j=this;var k=i.getGrid();var l=null;if(j.left){l=i.getDrawedArea()}else{l=e.vpv(e.sdv(i.scale,j.lastMove),{x:-i.viewX/i.scale,y:-i.viewY/i.scale})}i.areaSelect.apply(i,[l,k]);i.refreshGridLayer()}})};g.prototype.getDrawedArea=function(){var k=this;var j=k.getMouseReader();var p={x:-k.viewX/k.scale,y:-k.viewY/k.scale};var n=e.vpv(e.sdv(k.scale,j.lastDown.left),p);var l=e.vpv(e.sdv(k.scale,j.lastMove),p);var m=e.abs(l.x-n.x);var i=e.abs(l.y-n.y);var o={x:n.x,y:n.y,width:m,height:i};o.x=n.x>l.x?o.x-m:o.x;o.y=n.y>l.y?o.y-i:o.y;return o};g.prototype.refreshGridLayer=function(){var i=this;i.getGridLayer().clear().drawGrid(i.getGrid())};g.prototype.onAreaSelect=function(j){var i=this;i.areaSelect=j;return i};g.prototype.updateGrid=function(j){var i=this;i.getGridLayer().set(j).clear().drawGrid(i.getGrid().set(j));return i};g.prototype.redrawGrid=function(){var i=this;i.getGridLayer().clear().drawGrid(i.getGrid());return i};g.prototype.getGridLayer=function(){var i=this;if(i.gridLayer===null){i.gridLayer=i.createLayer()}return i.gridLayer};g.prototype.getGrid=function(){var j=this;if(j.grid===null){var k=j.getWidth();var i=j.getHeight();j.grid=new b({sw:k,sh:i,width:k,height:i})}return j.grid};g.prototype.getMouseReader=function(){console.log("Canvas Engine get mouse reader...");var i=this;if(i.mouseReader===null){i.mouseReader=new d(i.container)}return i.mouseReader};g.prototype.getKeyReader=function(){console.log("Canvas Engine get key reader...");var i=this;if(i.keyReader===null){i.keyReader=new h(i.container)}return i.keyReader};g.prototype.getWidth=function(){console.log("Canvas Engine get width...");return f(this.container).width()};g.prototype.getHeight=function(){console.log("Canvas Engine get height...");return f(this.container).height()};g.prototype.clearAllLayers=function(){console.log("Canvas engine clear all layers...");this.layers.forEach(function(i){i.clear()});return self};g.prototype.applyToLayers=function(j,k){console.log("Canvas engine apply to layers...");var i=this;i.layers.forEach(function(l){if(k===undefined||k.apply(l)){l.set(j)}});return i};g.prototype.createLayer=function(j,n){console.log("Canvas engine create layer..");j=j===undefined?{}:j;var m=j.type===undefined?"default":j.type;var k=null;var i=this;j.zIndex=i.layers.length;if(n!==undefined){k=new n(j,i)}else{k=new c(j,i)}i.layers.push(k);if(i.gridLayer!==null){var l=i.layers[i.layers.length-1];i.layers[i.layers.length-1]=i.gridLayer;i.layers[i.gridLayer.zIndex]=l;l.set({zIndex:i.gridLayer.zIndex});i.gridLayer.set({zIndex:i.layers.length-1})}f(document).ready(function(){f(i.container).append(k.getElement())});return k};g.prototype.getLayer=function(j){console.log("Canvas Engine get layer...");var i=this;if(i.layers[j]!==undefined){return i.layers[j]}return null};g.prototype.removeLayers=function(j){var i=this;j.forEach(function(k){i.removeLayer(k.zIndex)})};g.prototype.removeLayer=function(k){console.log("Canvas Engine remove layer...");var j=this;if(j.layers[k]!==undefined){j.layers[k].destroy();j.layers.splice(k,1);for(var l=k;l<j.layers.length;l++){j.layers[l].set({zIndex:l})}}return j};g.prototype.renderMap=function(q){console.log("Canvas Engine render map...");var k=this;k.clearAllLayers();var o=q.imageSets;var p=o.length;q.renderIntervals.forEach(function(i){clearInterval(i)});for(var m=0;m<p;m++){var n=o[m].length;for(var l=0;l<n;l++){o[m][l].forEach(function(i){q.renderIntervals.push(setTimeout(function(){var j=k.getLayer(i.layer);if(j!==null){j.set({width:q.width*q.tile_w,height:q.height*q.tile_h});j.drawImageSet(i)}},(20*m)+(l*20)))})}}q.parent=k};g.createEngine=function(i){console.log("Canvas Engine create engine...");return new g(i)};return g});