define(["AppObject","Math","MouseReader","CanvasLayer","GridLayer","KeyReader","Grid","jquery","Validator"],function(d,a,j,h,b,g,e,f,c){var i=function(l){console.log("intializing canvas engine...");var k=this;k.layers=[];k.height=400;k.width=400;k.viewX=0;k.viewY=0;k.lastViewX=0;k.lastViewY=0;k.width=400;k.mouseReader=null;k.keyReader=null;k.draggable=false;k.scalable=false;k.selectable=false;k.multiSelect=false;k.grid=null;k.scale=1;k.gridLayer=null;k.animationLayer=null;k.areaSelect=null;k.container=null;d.call(k);i.bindProperties.apply(k);k.set(l)};i.prototype=Object.create(d.prototype);i.prototype.constructor=i;i.bindProperties=function(){var k=this;k._onChange("viewX",function(l){k.layers.forEach(function(m){f(m.getElement()).css({left:l})})});k._onChange("viewY",function(l){k.layers.forEach(function(m){f(m.getElement()).css({top:l})})});k._beforeSet("scale",function(){return 1});k._onChange("width",function(l){f(k.container).css({width:l})});k._onChange("height",function(l){f(k.container).css({height:l})});k._onChange("container",function(l){f(l).css({position:"relative",overflow:"hidden",width:k.width,height:k.height}).addClass("transparent-background canvas-engine").on("contextmenu",function(m){m.preventDefault()}).empty();k.getMouseReader().set({element:l});k.keyReader=null});k._beforeSet("container",function(l,m){l=f(l)[0];m=f(m)[0];m=c.validateElement(l,m);if(l!==m){f(l).empty()}return m})};i.prototype.getDrawedArea=function(){var m=this;var l=m.getMouseReader();var r={x:-m.viewX/m.scale,y:-m.viewY/m.scale};var p=a.vpv(a.sdv(m.scale,l.lastDown.left),r);var n=a.vpv(a.sdv(m.scale,l.lastMove),r);var o=a.abs(n.x-p.x);var k=a.abs(n.y-p.y);var q={x:p.x,y:p.y,width:o,height:k};q.x=p.x>n.x?q.x-o:q.x;q.y=p.y>n.y?q.y-k:q.y;return q};i.prototype.refreshGridLayer=function(){var k=this;k.getGridLayer().clear().drawGrid(k.getGrid())};i.prototype.onAreaSelect=function(l){var k=this;k.areaSelect=l;return k};i.prototype.updateGrid=function(l){var k=this;k.getGridLayer().set(l).clear().drawGrid(k.getGrid().set(l));return k};i.prototype.redrawGrid=function(){var k=this;k.getGridLayer().clear().drawGrid(k.getGrid());return k};i.prototype.getGridLayer=function(){var k=this;if(k.gridLayer===null){k.gridLayer=k.createLayer({name:"grid-layer"},b)}return k.gridLayer};i.prototype.getGrid=function(){var l=this;if(l.grid===null){var m=l.getWidth();var k=l.getHeight();l.grid=new e({sw:m,sh:k,width:m,height:k})}return l.grid};i.prototype.getMouseReader=function(){var k=this;if(k.mouseReader===null){k.mouseReader=new j({element:k.container});k.mouseReader.onmousedown(3,function(){k.lastViewX=k.viewX;k.lastViewY=k.viewY});k.mouseReader.onmousemove(function(o){var n=this;if(k.draggable&&n.right){var v=n.lastDown.right;var t=n.lastMove;var l=a.vmv(v,t);var u=k.lastViewX-l.x;var r=k.lastViewY-l.y;var m=k.getLayer(0);var s=k.getWidth()-m.width;var q=k.getHeight()-m.height;s=s>0?0:s;q=q>0?0:q;u=a.min(a.max(u,s),0);r=a.min(a.max(r,q),0);k.set({viewX:u,viewY:r})}});k.mouseReader.onmousedown(1,function(){if(k.selectable&&typeof k.areaSelect==="function"){var l=this;var p={x:a.abs(k.viewX/k.scale),y:a.abs(k.viewY/k.scale)};var n=a.vpv(a.sdv(k.scale,l.lastDown.left),p);var o={x:n.x,y:n.y};var m=k.getGrid();k.areaSelect.apply(k,[o,m]);k.refreshGridLayer()}});k.mouseReader.onmousemove(function(o){if(k.multiSelect&&k.selectable&&typeof k.areaSelect==="function"){var l=this;var m=k.getGrid();var n=null;if(l.left){n=k.getDrawedArea()}else{n=a.vpv(a.sdv(k.scale,l.lastMove),{x:-k.viewX/k.scale,y:-k.viewY/k.scale})}k.areaSelect.apply(k,[n,m]);k.refreshGridLayer()}})}return k.mouseReader};i.prototype.getKeyReader=function(){var k=this;if(k.keyReader===null){k.keyReader=new g(k.container)}return k.keyReader};i.prototype.getWidth=function(){return f(this.container).width()};i.prototype.getHeight=function(){return f(this.container).height()};i.prototype.clearAllLayers=function(){var k=this;this.layers.forEach(function(l){if(!(l instanceof b)){l.clear()}});return k};i.prototype.applyToLayers=function(l,m){var k=this;k.layers.forEach(function(n){if(!(n instanceof b)){if(m===undefined||m.apply(n)){n.set(l)}}});return k};i.prototype.createLayer=function(l,o){l=c.validateObject({},l);var m=null;var k=this;l.zIndex=k.layers.length;l.width=c.validateNumber(k.getWidth(),l.width);l.height=c.validateNumber(k.getHeight(),l.height);if(o!==undefined){m=new o(l,k)}else{m=new h(l,k)}k.layers.push(m);if(k.gridLayer!==null){var n=k.layers[k.layers.length-1];k.layers[k.layers.length-1]=k.gridLayer;k.layers[k.gridLayer.zIndex]=n;n.set({zIndex:k.gridLayer.zIndex});k.gridLayer.set({zIndex:k.layers.length-1})}if(k.container!==null){f(k.container).append(m.getElement())}return m};i.prototype.getLayer=function(l){var k=this;if(k.layers[l]!==undefined&&!(k.layers[l] instanceof b)){return k.layers[l]}return null};i.prototype.removeLayers=function(l){var k=this;l.forEach(function(m){k.removeLayer(m)})};i.prototype.removeLayer=function(n){var k=this;var l=-1;if(!(n instanceof b)&&n instanceof h){l=k.layers.indexOf(n)}else{if(c.isInt(n)&&k.layers[n]!==undefined){l=n}}if(l!==-1){k.layers[l].destroy();k.layers.splice(l,1);for(var m=l;m<k.layers.length;m++){k.layers[m].set({zIndex:m})}}return k};i.prototype.renderMap=function(q){var k=this;k.clearAllLayers();var o=q.imageSets;var p=o.length;q.renderIntervals.forEach(function(r){clearInterval(r)});for(var m=0;m<p;m++){if(o[m]!==undefined){var n=o[m].length;for(var l=0;l<n;l++){if(o[m][l]!==undefined){o[m][l].forEach(function(r){q.renderIntervals.push(setTimeout(function(){var s=k.getLayer(r.layer);if(s!==null){s.set({width:q.width*q.tile_w,height:q.height*q.tile_h});s.drawImageSet(r)}},(20*m)+(l*20)))})}}}}q.parent=k};i.createEngine=function(k){return new i(k)};return i});