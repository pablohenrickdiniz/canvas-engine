define(["AppObject","Math","MouseReader","CanvasLayer","KeyReader"],function(a,d,c,b,f){var e=function(h){console.log("intializing canvas engine...");var g=this;g.layers=[];g.height=400;g.width=400;g.viewX=0;g.viewY=0;g.lastViewX=0;g.lastViewY=0;g.width=400;g.mouseReader=null;g.keyReader=null;g.draggable=false;g.scalable=false;g.selectable=false;g.multiSelect=false;g.grid=null;g.scale=1;g.gridLayer=null;g.animationLayer=null;g.areaSelect=null;g.container=null;g.bindProperties();g.set(h);g.initialize()};e.prototype=new a;e.prototype.bindProperties=function(){var g=this;g.onChange("viewX",function(h){g.layers.forEach(function(i){$(i.getElement()).css({left:h})})});g.onChange("viewY",function(h){g.layers.forEach(function(i){$(i.getElement()).css({top:h})})});g.onChange("scale",function(h){g.layers.forEach(function(i){$(i.getElement()).css({transform:"scale("+h+","+h+")",transformOrigin:"0 0",webkitTransform:"scale("+h+","+h+")",webkitTransformOrigin:"0 0",mozTransform:"scale("+h+")",mozTransformOrigin:"0 0",oTransform:"scale("+h+","+h+")",oTransformOrigin:"0 0",msTransform:"scale("+h+","+h+")",msTransformOrigin:"0 0"})})});g.onChange("width",function(h){$(g.container).css({width:h})});g.onChange("height",function(h){$(g.container).css({height:h})});g.onChange("container",function(h){console.log("container changed!");$(h).css({position:"relative",overflow:"hidden",width:g.width,height:g.height}).addClass("transparent-background canvas-engine").on("contextmenu",function(i){i.preventDefault()})})};e.prototype.initialize=function(){var g=this;$(g.container).empty();g.getMouseReader().onmousedown(3,function(){g.lastViewX=g.viewX;g.lastViewY=g.viewY});g.getMouseReader().onmousemove(function(k){var j=this;if(g.draggable&&j.right){var r=j.lastDown.right;var o=j.lastMove;var h=d.vmv(r,o);var q=g.lastViewX-h.x;var m=g.lastViewY-h.y;var i=g.getLayer(0);var n=g.getWidth()-i.width;var l=g.getHeight()-i.height;n=n>0?0:n;l=l>0?0:l;q=d.min(d.max(q,n),0);m=d.min(d.max(m,l),0);g.set({viewX:q,viewY:m})}});g.getMouseReader().onmousewheel(function(i){var h=this;if(g.scalable){var j=h.lastWheel;if(j<0){if(g.scale>0.2){g.set({scale:g.scale-0.1})}}else{if(j>0){g.set({scale:g.scale+0.1})}}}});g.getMouseReader().onmousedown(1,function(){if(g.selectable&&typeof g.areaSelect=="function"){var h=this;var l={x:d.abs(g.viewX/g.scale),y:d.abs(g.viewY/g.scale)};var j=d.vpv(d.sdv(g.scale,h.lastDown.left),l);var k={x:j.x,y:j.y};var i=g.getGrid();g.areaSelect.apply(g,[k,i]);g.refreshGridLayer()}});g.getMouseReader().onmousemove(function(k){if(g.multiSelect&&g.selectable&&typeof g.areaSelect=="function"){console.log("mouse move...");var h=this;var i=g.getGrid();var j=null;if(h.left){j=g.getDrawedArea()}else{j=d.vpv(d.sdv(g.scale,h.lastMove),{x:-g.viewX/g.scale,y:-g.viewY/g.scale})}g.areaSelect.apply(g,[j,i]);g.refreshGridLayer()}})};e.prototype.getDrawedArea=function(){var i=this;var h=i.getMouseReader();var n={x:-i.viewX/i.scale,y:-i.viewY/i.scale};var l=d.vpv(d.sdv(i.scale,h.lastDown.left),n);var j=d.vpv(d.sdv(i.scale,h.lastMove),n);var k=d.abs(j.x-l.x);var g=d.abs(j.y-l.y);var m={x:l.x,y:l.y,width:k,height:g};m.x=l.x>j.x?m.x-k:m.x;m.y=l.y>j.y?m.y-g:m.y;return m};e.prototype.refreshGridLayer=function(){var g=this;g.getGridLayer().clear().drawGrid(g.getGrid())};e.prototype.onAreaSelect=function(h){var g=this;g.areaSelect=h;return g};e.prototype.updateGrid=function(h){var g=this;g.getGridLayer().set(h).clear().drawGrid(g.getGrid().set(h));return g};e.prototype.redrawGrid=function(){var g=this;g.getGridLayer().clear().drawGrid(g.getGrid());return g};e.prototype.getGridLayer=function(){var g=this;if(g.gridLayer==null){g.gridLayer=g.createLayer()}return g.gridLayer};e.prototype.getGrid=function(){var h=this;if(h.grid==null){var i=h.getWidth();var g=h.getHeight();h.grid=new Grid({sw:i,sh:g,width:i,height:g})}return h.grid};e.prototype.getMouseReader=function(){console.log("Canvas Engine get mouse reader...");var g=this;if(g.mouseReader==null){g.mouseReader=new c(g.container)}return g.mouseReader};e.prototype.getKeyReader=function(){console.log("Canvas Engine get key reader...");var g=this;if(g.keyReader==null){g.keyReader=new f(g.container)}return g.keyReader};e.prototype.resize=function(h){console.log("Canvas Engine resize...");var g=this;g.width=Parser.parsePercent(h,$(g.container).parent());return g};e.prototype.getWidth=function(){console.log("Canvas Engine get width...");return $(this.container).width()};e.prototype.getHeight=function(){console.log("Canvas Engine get height...");return $(this.container).height()};e.prototype.clearAllLayers=function(){console.log("Canvas engine clear all layers...");this.layers.forEach(function(g){g.clear()});return self};e.prototype.applyToLayers=function(h,i){console.log("Canvas engine apply to layers...");var g=this;g.layers.forEach(function(j){if(i==undefined||i.apply(j)){j.set(h)}});return g};e.prototype.createLayer=function(h,l){console.log("Canvas engine create layer..");h=h==undefined?{}:h;var k=h.type==undefined?"default":h.type;var i=null;var g=this;h.zIndex=g.layers.length;if(l!=undefined){i=new l(h,g)}else{i=new b(h,g)}g.layers.push(i);if(g.gridLayer!=null){var j=g.layers[g.layers.length-1];g.layers[g.layers.length-1]=g.gridLayer;g.layers[g.gridLayer.zIndex]=j;j.set({zIndex:g.gridLayer.zIndex});g.gridLayer.set({zIndex:g.layers.length-1})}$(document).ready(function(){$(g.container).append(i.getElement())});return i};e.prototype.getLayer=function(h){console.log("Canvas Engine get layer...");var g=this;if(g.layers[h]!=undefined){return g.layers[h]}return null};e.prototype.removeLayers=function(h){var g=this;h.forEach(function(i){g.removeLayer(i.zIndex)})};e.prototype.removeLayer=function(h){console.log("Canvas Engine remove layer...");var g=this;if(g.layers[h]!=undefined){g.layers[h].destroy();g.layers.splice(h,1);for(var j=h;j<g.layers.length;j++){g.layers[j].set({zIndex:j})}}return g};e.prototype.renderMap=function(o){console.log("Canvas Engine render map...");var g=this;g.clearAllLayers();var m=o.imageSets;var n=m.length;o.renderIntervals.forEach(function(i){clearInterval(i)});for(var k=0;k<n;k++){var l=m[k].length;for(var h=0;h<l;h++){m[k][h].forEach(function(i){o.renderIntervals.push(setTimeout(function(){var j=g.getLayer(i.layer);if(j!=null){j.set({width:o.width*o.tile_w,height:o.height*o.tile_h});j.drawImageSet(i)}},(20*k)+(h*20)))})}}o.parent=g};e.createEngine=function(g){console.log("Canvas Engine create engine...");return new e(g)};return e});