define(["jquery","AppObject","Color","Validator"],function(d,a,e,c){var b=function(h,g){console.log("Canvas Layer initialize...");var f=this;f.context=null;f.element=null;f.canvas=g;f.zIndex=0;f.width=300;f.height=300;f.left=0;f.top=0;f.savedStates=[];f.name="";f.mouseReader=null;f.element=null;f.opacity=1;f.backgroundColor="transparent";f._aftResize=function(){};b.bindProperties.apply(f);f.set(h)};b.prototype=new a();b.bindProperties=function(){var f=this;f._onChange("zIndex",function(g){d(f.getElement()).css({zIndex:g})});f._onChange("opacity",function(g){d(f.getElement()).css({opacity:g})});f._onChange("width",function(g){d(f.getElement()).attr("width",g)});f._onChange("height",function(g){d(f.getElement()).attr("height",g)});f._onChange("name",function(g){if(g.length===0){d(f.getElement()).removeAttr("data-name")}else{d(f.getElement()).attr("data-name",g)}});f._onChange("left",function(g){d(f.getElement()).css({left:g})});f._onChange("top",function(g){d(f.getElement()).css({top:g})});f._onChange("backgroundColor",function(g){d(f.getElement()).css({backgroundColor:g})});f._beforeSet("_aftResize",c.validateFunction);f._beforeSet("opacity",c.validateNumber);f._beforeSet("width",c.validateNumber);f._beforeSet("height",c.validateNumber);f._beforeSet("zIndex",c.validateInt);f._beforeSet("left",c.validateNumber);f._beforeSet("top",c.validateNumber);f._beforeSet("backgroundColor",c.validateColor);f._afterChange(function(){if(f._isChanged("width")||f._isChanged("height")){f._aftResize()}})};b.prototype.getVisibleArea=function(){var h=this;var i=Math.min(h.width,h.canvas.getWidth());var g=Math.min(h.height,h.canvas.getHeight());var f=Math.abs(h.canvas.viewX);var j=Math.abs(h.canvas.viewY);return{x:f,y:j,width:i,height:g}};b.prototype.isSetVisible=function(g){var f=this;var h=f.getVisibleArea();return !(g.x+g.width<h.x||h.x+h.width<g.x||g.y+g.height<h.y||h.y+h.height<g.y)};b.prototype.show=function(){var f=this;d(f.getElement()).css({visibility:"visible"});return f};b.prototype.hide=function(){var f=this;d(f.getElement()).css({visibility:"hidden"});return f};b.prototype.saveState=function(i){var g=this;var h=g.getElement().toDataURL("image/png");var f=document.createElement("img");f.src=h;g.savedStates[i]=f;return g};b.prototype.restoreState=function(g){var f=this;var h=f.savedStates[g];if(h!==undefined){f.getContext().drawImage(h,0,0)}return f};b.prototype.clearStates=function(){var f=this;f.savedStates=[];return f};b.prototype.getElement=function(){var f=this;if(f.element===null){f.element=document.createElement("canvas");d(f.element).css({pointerEvents:"none",userSelect:"none",position:"absolute",left:f.left,top:f.top,backgroundColor:f.backgroundColor,opacity:f.opacity})}return f.element};b.prototype.getContext=function(){var f=this;if(f.context===null){f.context=f.getElement().getContext("2d");if(f.context.setLineDash===undefined){f.context.setLineDash=function(){}}}return f.context};b.prototype.drawGrid=function(h){var f=this;var g=f.getContext();h.rectSets.forEach(function(i){i.forEach(function(j){g.fillStyle=j.fillStyle;g.strokeStyle=j.strokeStyle;g.setLineDash(j.lineDash);g.lineWidth=j.lineWidth;g.fillRect(j.x,j.y,j.width,j.height);g.strokeRect(j.x,j.y,j.width,j.height)})});h.parent=this;return f};b.prototype.drawAbstractGrid=function(f){var q=this;if(f.isDrawable()){var k=q.getContext();k.fillStyle="transparent";k.strokeStyle=(new e({alpha:0.2})).toRGBA();k.lineWidth=1;k.lineDash=[];var l=q.getVisibleArea();var h=l.x!==0?Math.floor(l.x/f.sw):0;var g=l.y!==0?Math.floor(l.y/f.sh):0;var p=Math.ceil((l.x+l.width)/f.sw);var o=Math.ceil((l.y+l.height)/f.sh);for(var n=h;n<p;n++){for(var m=g;m<o;m++){k.strokeRect((n*f.sw)+f.x,(m*f.sh)+f.y,f.sw,f.sh)}}}return q};b.prototype.drawRectSet=function(g){var f=this;var h=f.getContext();h.fillStyle=g.fillStyle;h.strokeStyle=g.strokeStyle;h.fillRect(g.x,g.y,g.width,g.height);h.strokeRect(g.x,g.y,g.width,g.height);return f};b.prototype.destroy=function(){var f=this;d(f.element).remove();if(f.canvas.layers[f.zIndex]!==undefined){delete f.canvas.layers[f.zIndex]}return f};b.prototype.drawImage=function(){var f=this;var g=f.getContext();g.drawImage.apply(g,arguments);return f};b.prototype.drawImageSet=function(h){var f=this;var g=f.getContext();h.parent=f;g.drawImage(h.image,h.sx,h.sy,h.sWidth,h.sHeight,h.x,h.y,h.width,h.height);if(h.selected){g.strokeStyle="rgba(0,0,100,0.5)";g.setLineDash([5,5]);g.strokeRect(h.x,h.y,h.width,h.height)}return f};b.prototype.clear=function(){var f=this;f.getContext().clearRect(0,0,f.width,f.height);return f};b.prototype.drawAnimation=function(h){var f=this;f.clearRect(h.x,h.y,h.width,h.height);var g=f.getContext();if(h.frames[h.indexFrame]!==undefined){h.frames[h.indexFrame].imageSets.forEach(function(i){g.drawImage(i.image,i.sx,i.sy,i.sWidth,i.sHeight,i.x+h.x,i.y+h.y,i.width,i.height)})}return f};b.prototype.getPixel=function(k,g){var f=this;var h=f.getContext();var l=h.getImageData(k,g,1,1).data;return new e({red:l[0],green:l[1],blue:l[2],alpha:l[3]})};b.prototype.clearRect=function(){var f=this;var g=f.getContext();g.clearRect.apply(g,arguments);return f};b.prototype.afterResize=function(g){var f=this;f.set({_aftResize:g})};return b});