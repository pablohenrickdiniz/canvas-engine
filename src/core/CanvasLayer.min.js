define(["jquery","AppObject","Color"],function(c,a,d){var b=function(g,f){console.log("Canvas Layer initialize...");var e=this;e.context=null;e.canvas=f;e.zIndex=0;e.width=300;e.height=300;e.savedStates=[];e.name="";e.mouseReader=null;e.element=null;e.opacity=1;c(window).resize(function(){e.updateElement()});c(e.getElement()).css({userSelect:"none"});b.bindProperties.apply(e);e.set(g)};b.prototype=new a();b.bindProperties=function(){var e=this;e._onChange("zIndex",function(f){c(e.getElement()).css({zIndex:f})});e._onChange("opacity",function(f){c(e.getElement()).css({opacity:f})});e._onChange("width",function(f){c(e.getElement()).attr("width",f)});e._onChange("height",function(f){c(e.getElement()).attr("height",f)})};b.prototype.getVisibleArea=function(){console.log("Canvas Layer get visible Area...");var g=this;var h=Math.min(g.width,g.canvas.getWidth());var f=Math.min(g.height,g.canvas.getHeight());var e=Math.abs(g.canvas.viewX);var i=Math.abs(g.canvas.viewY);return{x:e,y:i,width:h,height:f}};b.prototype.isSetVisible=function(f){var e=this;var g=e.getVisibleArea();return !(f.x+f.width<g.x||g.x+g.width<f.x||f.y+f.height<g.y||g.y+g.height<f.y)};b.prototype.show=function(){var e=this;c(e.getElement()).css({visibility:"visible"});return e};b.prototype.hide=function(){var e=this;c(e.getElement()).css({visibility:"hidden"});return e};b.prototype.saveState=function(h){var f=this;var g=f.getElement().toDataURL("image/png");var e=document.createElement("img");e.src=g;f.savedStates[h]=e;return f};b.prototype.restoreState=function(f){var e=this;var g=e.savedStates[f];if(g!==undefined){e.getContext().drawImage(g,0,0)}return e};b.prototype.clearStates=function(){var e=this;e.savedStates=[];return e};b.prototype.getElement=function(){var e=this;if(e.element===null&&e.canvas!==null){e.element=document.createElement("canvas");c(e.element).css({zIndex:e.zIndex,position:"absolute",backgroundColor:"transparent",left:e.canvas.viewX,top:e.canvas.viewY,pointerEvents:"none"});c(e.element).addClass("canvas-layer");c(e.element).attr("width",e.width);c(e.element).attr("height",e.height);if(e.name!==""){c(e.element).attr("data-name",e.name)}}return e.element};b.prototype.getContext=function(){var e=this;if(e.context===null){e.context=e.getElement().getContext("2d")}return e.context};b.prototype.drawGrid=function(g){var e=this;var f=e.getContext();g.rectSets.forEach(function(h){h.forEach(function(i){f.fillStyle=i.fillStyle;f.strokeStyle=i.strokeStyle;f.setLineDash(i.lineDash);f.lineWidth=i.lineWidth;f.fillRect(i.x,i.y,i.width,i.height);f.strokeRect(i.x,i.y,i.width,i.height)})});g.parent=this;return e};b.prototype.drawAbstractGrid=function(e){var p=this;if(e.isDrawable()){var h=p.getContext();h.fillStyle="transparent";h.strokeStyle=(new d({alpha:0.2})).toRGBA();h.lineWidth=1;h.lineDash=[];var k=p.getVisibleArea();var g=k.x!==0?Math.floor(k.x/e.sw):0;var f=k.y!==0?Math.floor(k.y/e.sh):0;var o=Math.ceil((k.x+k.width)/e.sw);var n=Math.ceil((k.y+k.height)/e.sh);for(var m=g;m<o;m++){for(var l=f;l<n;l++){h.strokeRect((m*e.sw)+e.x,(l*e.sh)+e.y,e.sw,e.sh)}}}return p};b.prototype.drawRectSet=function(f){var e=this;var g=e.getContext();g.fillStyle=f.fillStyle;g.strokeStyle=f.strokeStyle;g.fillRect(f.x,f.y,f.width,f.height);g.strokeRect(f.x,f.y,f.width,f.height);return e};b.prototype.destroy=function(){var e=this;c(e.element).remove();if(e.canvas.layers[e.zIndex]!==undefined){delete e.canvas.layers[e.zIndex]}return e};b.prototype.drawImage=function(){var e=this;var f=e.getContext();f.drawImage.apply(f,arguments);return e};b.prototype.drawImageSet=function(g){var e=this;var f=e.getContext();g.parent=e;f.drawImage(g.image,g.sx,g.sy,g.sWidth,g.sHeight,g.x,g.y,g.width,g.height);if(g.selected){f.strokeStyle="rgba(0,0,100,0.5)";f.setLineDash([5,5]);f.strokeRect(g.x,g.y,g.width,g.height)}return e};b.prototype.clear=function(){var e=this;e.getContext().clearRect(0,0,e.width,e.height);return e};b.prototype.drawAnimation=function(g){var e=this;e.clearRect(g.x,g.y,g.width,g.height);var f=e.getContext();if(g.frames[g.indexFrame]!==undefined){g.frames[g.indexFrame].imageSets.forEach(function(h){f.drawImage(h.image,h.sx,h.sy,h.sWidth,h.sHeight,h.x+g.x,h.y+g.y,h.width,h.height)})}return e};b.prototype.getPixel=function(h,f){var e=this;var g=e.getContext();var k=g.getImageData(h,f,1,1).data;return new d({red:k[0],green:k[1],blue:k[2],alpha:k[3]})};b.prototype.updateElement=function(){var e=this;var g=0;var f=0;var h=1;if(e.canvas!==undefined){g=e.canvas.viewX;f=e.canvas.viewY;h=e.canvas.scale}c(e.getElement()).css({left:g,top:f,scale:h});return e};b.prototype.clearRect=function(){var e=this;var f=e.getContext();f.clearRect.apply(f,arguments);return e};return b});