define(["jquery","AppObject"],function(c,a){var b=function(f,e){console.log("Canvas Layer initialize...");var d=this;d.context=null;d.canvas=e;d.zIndex=0;d.width=300;d.height=300;d.savedStates=[];d.name="";d.mouseReader=null;d.element=null;d.opacity=1;c(window).resize(function(){d.updateElement()});c(d.getElement()).css({userSelect:"none"});d.bindProperties();d.set(f)};b.prototype=new a;b.prototype.bindProperties=function(){var d=this;d.onChange("zIndex",function(e){c(d.getElement()).css({zIndex:e})});d.onChange("opacity",function(e){c(d.getElement()).css({opacity:e})});d.onChange("width",function(e){d.resize(e,d.height)});d.onChange("height",function(e){d.resize(d.width,e)})};b.prototype.resize=function(f,d){var e=this;c(e.getElement()).attr("width",f);c(e.getElement()).attr("height",d);return e};b.prototype.getVisibleArea=function(){console.log("Canvas Layer get visible Area...");var f=this;var g=Math.min(f.width,f.canvas.getWidth());var e=Math.min(f.height,f.canvas.getHeight());var d=Math.abs(f.canvas.viewX);var h=Math.abs(f.canvas.viewY);return{x:d,y:h,width:g,height:e}};b.prototype.isSetVisible=function(e){var d=this;var f=d.getVisibleArea();return !(e.x+e.width<f.x||f.x+f.width<e.x||e.y+e.height<f.y||f.y+f.height<e.y)};b.prototype.show=function(){var d=this;c(d.getElement()).css({visibility:"visible"});return d};b.prototype.hide=function(){var d=this;c(d.getElement()).css({visibility:"hidden"});return d};b.prototype.saveState=function(g){var e=this;var f=e.getElement().toDataURL("image/png");var d=document.createElement("img");d.src=f;e.savedStates[g]=d;return e};b.prototype.restoreState=function(e){var d=this;var f=d.savedStates[e];if(f!=undefined){d.getContext().drawImage(f,0,0)}return d};b.prototype.clearStates=function(){var d=this;d.savedStates=[];return d};b.prototype.getElement=function(){var d=this;if(d.element==null&&d.canvas!=null){d.element=document.createElement("canvas");c(d.element).css({zIndex:d.zIndex,position:"absolute",backgroundColor:"transparent",left:d.canvas.viewX,top:d.canvas.viewY,pointerEvents:"none"});c(d.element).addClass("canvas-layer");c(d.element).attr("width",d.width);c(d.element).attr("height",d.height);if(d.name!=""){c(d.element).attr("data-name",d.name)}}return d.element};b.prototype.getContext=function(){var d=this;if(d.context==null){d.context=d.getElement().getContext("2d")}return d.context};b.prototype.drawGrid=function(f){var d=this;var e=d.getContext();f.rectSets.forEach(function(g){g.forEach(function(h){e.fillStyle=h.fillStyle;e.strokeStyle=h.strokeStyle;e.setLineDash(h.lineDash);e.lineWidth=h.lineWidth;e.fillRect(h.x,h.y,h.width,h.height);e.strokeRect(h.x,h.y,h.width,h.height)})});f.parent=this;return d};b.prototype.drawAbstractGrid=function(d){if(d.isDrawable()){var o=this;var g=o.getContext();g.fillStyle="transparent";g.strokeStyle=(new Color({alpha:0.2})).toRGBA();g.lineWidth=1;g.lineDash=[];var h=o.getVisibleArea();var f=h.x!=0?Math.floor(h.x/d.sw):0;var e=h.y!=0?Math.floor(h.y/d.sh):0;var n=Math.ceil((h.x+h.width)/d.sw);var m=Math.ceil((h.y+h.height)/d.sh);for(var l=f;l<n;l++){for(var k=e;k<m;k++){g.strokeRect((l*d.sw)+d.x,(k*d.sh)+d.y,d.sw,d.sh)}}}return o};b.prototype.drawRectSet=function(e){var d=this;var f=d.getContext();f.fillStyle=e.fillStyle;f.strokeStyle=e.strokeStyle;f.fillRect(e.x,e.y,e.width,e.height);f.strokeRect(e.x,e.y,e.width,e.height);return d};b.prototype.destroy=function(){var d=this;c(d.element).remove();if(d.canvas.layers[d.zIndex]!=undefined){delete d.canvas.layers[d.zIndex]}return d};b.prototype.drawImage=function(){var d=this.getContext();d.drawImage.apply(d,arguments);return self};b.prototype.drawImageSet=function(e){var d=this.getContext();e.parent=this;d.drawImage(e.image,e.sx,e.sy,e.sWidth,e.sHeight,e.x,e.y,e.width,e.height);if(e.selected){d.strokeStyle="rgba(0,0,100,0.5)";d.setLineDash([5,5]);d.strokeRect(e.x,e.y,e.width,e.height)}return self};b.prototype.clear=function(){var d=this;d.getContext().clearRect(0,0,d.width,d.height);return d};b.prototype.drawAnimation=function(f){var d=this;d.clearRect(f.x,f.y,f.width,f.height);var e=d.getContext();if(f.frames[f.indexFrame]!=undefined){f.frames[f.indexFrame].imageSets.forEach(function(g){e.drawImage(g.image,g.sx,g.sy,g.sWidth,g.sHeight,g.x+f.x,g.y+f.y,g.width,g.height)})}return d};b.prototype.getPixel=function(h,f){var e=this;var g=e.getContext();var k=g.getImageData(h,f,1,1).data;var d=new Color({red:k[0],green:k[1],blue:k[2],alpha:k[3]});return d};b.prototype.updateElement=function(){var d=this;var f=0;var e=0;var g=1;if(d.canvas!=undefined){f=d.canvas.viewX;e=d.canvas.viewY;g=d.canvas.scale}c(d.getElement()).css({left:f,top:e,scale:g});return d};b.prototype.clearRect=function(){var d=this;var e=d.getContext();e.clearRect.apply(e,arguments);return d};return b});