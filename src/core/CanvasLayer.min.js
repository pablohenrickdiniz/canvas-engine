define(["jquery","AppObject","Color","Validator","lodash"],function(e,a,f,d,c){var b=function(i,h){console.log("Canvas Layer initialize...");var g=this;g.context=null;g.element=null;g.canvas=h;g.zIndex=0;g.width=300;g.height=300;g.left=0;g.top=0;g.savedStates=[];g.name="";g.mouseReader=null;g.element=null;g.opacity=1;g.visible=true;g.backgroundColor="transparent";g.defaultValues={rect:{x:0,y:0,width:10,height:10,backgroundColor:"transparent",borderColor:"black",rotate:45,origin:{x:0,y:0},opacity:100},circle:{x:0,y:0,radius:10,backgroundColor:"transparent",borderColor:"black",origin:{x:0,y:0},opacity:100},polygon:{backgroundColor:"transparent",borderColor:"black",origin:{x:0,y:0},opacity:100},image:{image:null,sx:0,sy:0,sWidth:"dWidth",sHeight:"dHeight",dx:0,dy:0,dWidth:"default",dHeight:"default"}};g.transparentRegex=/^\s*transparent\s*|rgba\((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\s*,\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\s*,\s*(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\s*,\s*0\s*\)\s*$/;g.setContext(g.defaultValues.context);a.call(g);b.bindProperties.apply(g);g.set(i)};b.prototype=Object.create(a.prototype);b.prototype.constructor=b;b.bindProperties=function(){var g=this;g._onChange("zIndex",function(h){e(g.getElement()).css({zIndex:h})});g._onChange("opacity",function(h){e(g.getElement()).css({opacity:h})});g._onChange("visible",function(h){if(h){g.show()}else{g.hide()}});g._onChange("width",function(h){e(g.getElement()).prop("width",h)});g._onChange("height",function(h){e(g.getElement()).prop("height",h)});g._onChange("name",function(h){if(h.length===0){e(g.getElement()).removeAttr("data-name")}else{e(g.getElement()).attr("data-name",h)}});g._onChange("left",function(h){e(g.getElement()).css({left:h})});g._onChange("top",function(h){e(g.getElement()).css({top:h})});g._onChange("backgroundColor",function(h){e(g.getElement()).css({backgroundColor:h})});g._beforeSet("_aftResize",d.validateFunction);g._beforeSet("opacity",d.validateNumber);g._beforeSet("width",d.validateNumber);g._beforeSet("height",d.validateNumber);g._beforeSet("zIndex",d.validateInt);g._beforeSet("left",d.validateNumber);g._beforeSet("top",d.validateNumber);g._beforeSet("backgroundColor",d.validateColor);g._beforeSet("visible",d.validateBoolean)};b.prototype.getVisibleArea=function(){var i=this;var j=Math.min(i.width,i.canvas.getWidth());var h=Math.min(i.height,i.canvas.getHeight());var g=Math.abs(i.canvas.viewX);var k=Math.abs(i.canvas.viewY);return{x:g,y:k,width:j,height:h}};b.prototype.isSetVisible=function(h){var g=this;var i=g.getVisibleArea();return !(h.x+h.width<i.x||i.x+i.width<h.x||h.y+h.height<i.y||i.y+i.height<h.y)};b.prototype.show=function(){var g=this;e(g.getElement()).css({visibility:"visible"});return g};b.prototype.hide=function(){var g=this;e(g.getElement()).css({visibility:"hidden"});return g};b.prototype.saveState=function(j){var h=this;var i=h.getElement().toDataURL("image/png");var g=document.createElement("img");g.src=i;h.savedStates[j]=g;return h};b.prototype.restoreState=function(h){var g=this;var i=g.savedStates[h];if(i!==undefined){g.getContext().drawImage(i,0,0)}return g};b.prototype.clearStates=function(){var g=this;g.savedStates=[];return g};b.prototype.getElement=function(){var g=this;if(g.element===null){g.element=document.createElement("canvas");e(g.element).css({pointerEvents:"none",userSelect:"none",position:"absolute",left:g.left,top:g.top,backgroundColor:g.backgroundColor,opacity:g.opacity})}return g.element};b.prototype.getContext=function(){var g=this;if(g.context===null){g.context=g.getElement().getContext("2d");if(g.context.setLineDash===undefined){g.context.setLineDash=function(){}}}return g.context};b.prototype.destroy=function(){var g=this;e(g.element).remove();if(g.canvas.layers[g.zIndex]!==undefined){delete g.canvas.layers[g.zIndex]}};b.prototype.drawImageSet=function(i){var g=this;var h=g.getContext();i.parent=g;h.drawImage(i.image,i.sx,i.sy,i.sWidth,i.sHeight,i.x,i.y,i.width,i.height);if(i.selected){h.strokeStyle="rgba(0,0,100,0.5)";h.setLineDash([5,5]);h.strokeRect(i.x,i.y,i.width,i.height)}return g};b.prototype.clear=function(){var g=this;g.getContext().clearRect(0,0,g.width,g.height);return g};b.prototype.drawAnimation=function(h){var g=this;g.clearRect({x:h.x,y:h.y,width:h.width,height:h.height});if(h.frames[h.indexFrame]!==undefined){var i=h.frames[h.indexFrame];g.image(i)}return g};b.prototype.getPixel=function(l,h){var g=this;var k=g.getContext();var m=k.getImageData(l,h,1,1).data;return new f({red:m[0],green:m[1],blue:m[2],alpha:m[3]})};b.prototype.afterResize=function(h){var g=this;g.set({_aftResize:h})};b.prototype.image=function(r){var p=this;r=r==undefined?p.defaultValues.image:c.merge(p.defaultValues.image,r);var h=r.image;if(h!=null&&h instanceof HTMLImageElement){var l=h.width;var i=h.height;var g=h.width;var j=h.height;var n=r.sx;var m=r.sy;var q=r.dx;var o=r.dy;var k;if(d.isPercent(r.dWidth)){k=parseFloat(r.dWidth.replace("%",""));l=l*(k/100)}else{if(d.isNumber(r.dWidth)&&r.dWidth>0){l=r.dWidth}}if(d.isPercent(r.dHeight)){k=parseFloat(r.dHeight.replace("%",""));i=i*(k/100)}else{if(d.isNumber(r.dHeight)&&r.dHeight>0){i=r.dHeight}}if(d.isNumber(r.sWidth)&&r.sWidth>0){g=r.sWidth}if(d.isNumber(r.sHeight)&&r.sHeight>0){j=r.sHeight}if(l>0&&i>0){this.getContext().drawImage(h,n,m,g,j,q,o,l,i)}}return p};b.prototype.circle=function(h){var g=this;h=h==undefined?g.defaultValues.circle:c.merge(g.defaultValues.circle,h);var i=g.getContext();i.save();i.arc(h.x,h.y,h.radius,0,Math.PI);if(i.fillStyle!=null&&!g.transparentRegex.test(i.fillStyle)){i.fill()}if(i.strokeStyle!=null&&!g.transparentRegex.test(i.strokeStyle)){i.stroke()}i.restore();return g};b.prototype.rect=function(h){var g=this;h=h==undefined?g.defaultValues.rect:c.merge(g.defaultValues.rect,h);g.setContext(h);var i=g.getContext();i.save();if(i.fillStyle!=null&&!g.transparentRegex.test(i.fillStyle)){i.fillRect(h.x,h.y,h.width,h.height)}if(i.strokeStyle!=null&&!g.transparentRegex.test(i.strokeStyle)){i.strokeRect(h.x,h.y,h.width,h.height)}i.restore();return g};b.prototype.clearRect=function(h){var g=this;h=h==undefined?g.defaultValues.rect:c.merge(g.defaultValues.rect,h);var i=g.getContext();i.clearRect(h.x,h,y,h.width,h.height);return g};b.prototype.clearCircle=function(h){var g=this;h=h==undefined?g.defaultValues.circle:c.merge(g.defaultValues.circle,h);var i=g.getContext();i.save();i.arc(h.x,h.y,h.radius,0,Math.PI);i.clip();i.clearRect(h.x-h.radius,h.y-h.radius,h.radius*2,h.radius*2);i.restore();return g};b.prototype.setContext=function(h){var g=this;var i=g.getContext();if(h.backgroundColor!=undefined){i.fillStyle=h.backgroundColor}if(h.borderColor!=undefined){i.strokeStyle=h.borderColor}if(h.opacity!=undefined){i.globalAlpha=h.opacity/100}if(h.origin!=undefined){i.translate(h.origin.x,h.origin.y)}return g};return b});